name: Package helm chart
on:
  push:
    branches: [main]
    # paths:
    #   - spinnaker/app/**
jobs:
  package-and-refresh-index:
    name: Package charts and refresh index
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install helm
        uses: azure/setup-helm@v1.1
        with:
          version: v3.7.0
      - name: Package charts
        run: |
          SOURCE_CHART_DIR="spinnaker/app"
          PACKAGED_CHART_DIR="helm-chart-repository/spinnaker"
          rm -rf "${PACKAGED_CHART_DIR}"
          for DIR in ${SOURCE_CHART_DIR}/* ; do
            [ ! -d "${DIR}" ] && continue
            CHART_VERSION=$(helm show chart ${DIR} | yq '.version')
            GIT_SHA_SHORT=$(git rev-parse --short HEAD)
            RELEASE_VERSION=${CHART_VERSION}+${GIT_SHA_SHORT}
            echo "Release version will be ${RELEASE_VERSION}"
            helm dependency update "${DIR}"
            helm package "${DIR}" --version "${RELEASE_VERSION}" -d "${PACKAGED_CHART_DIR}"
          done
      - name: Update index.yaml
        run: helm repo index helm-chart-repository
      - name: Push changes
        run: |
          git config --global user.email "${{github.event.pusher.email}}"
          git config --global user.name "${{github.event.pusher.name}}"
          cd helm-chart-repository
          git add .
          git commit -m "packaged and updated chart index.yml"
          git push origin main
